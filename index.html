<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Facebook Idol</title>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
	<script src="http://www.rtcmulticonnection.org/latest.js"></script>
	<script src="/socket.io/socket.io.js"></script>
	<link href="//netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css" rel="stylesheet">
	<link href="css/styles.css" rel="stylesheet">
	<script>
		// (function(){
			function rand(){
				return Math.random()*Math.pow(2,53);
			};
			// Init socketio
			var socket = io.connect(location.protocol + "//" + location.hostname + ":" + (location.port || "80"));
			var connection = null;
			var userId = 'user-' + rand();
			var api = {
				heartbeat: function(heartbeat) {
					console.log('heartbeat', heartbeat, 'at', Date.now());
				},
			};
			skipRTCMultiConnectionLogs = true;
			function join(room){
				socket.on('start song', function(data){ // client
					$("<div class='player'>")
						.text(data.streamId)
						.appendTo($(".main").empty())
						.wrap("<div class='video-container player-container'>"); // and show video
					$(function(){
						var id = room + '-' + data.streamId
						var isMaster = userId == data.src;
						$("body").removeClass("self-master self-slave").addClass("self-" + (isMaster ? "master" : "slave"));
						console.log('start song', id, data, 'src', isMaster);
						connection = new RTCMultiConnection(id);
						connection.autoCloseEntireSession = true;
						connection.extra = {userId: userId};
						connection.onstream = function(e) {
							console.log('stream added', e);
							var $video = $(e.mediaElement)
								.addClass(e.extra.userId == userId ? "me" : "you")
								.addClass(e.extra.userId == data.src ? "master" : "slave")
								.removeAttr("controls");
							$video.appendTo($video.hasClass("master") ? $(".main") : "#target")
								.wrap("<div class='video-container'>");
							e.mediaElement.play();
							if ($video.hasClass("master")){ // also, chrome doesn't like remote streams
								var ac = new (window.webkitAudioContext || window.AudioContext);
								var analyser = ac.createAnalyser();
								var source = ac.createMediaStreamSource(e.stream);
								var node = ac.createJavaScriptNode(1024, 1, 1);
								analyser.smoothingTimeConstant = 0.2;
								analyser.fftSize = 512;
								source.connect(analyser);
								analyser.connect(node);
								node.connect(ac.destination);
								var cvs = $("<canvas class='spectrum'>").appendTo(".main")[0];
								cvs.width = 512;
								cvs.height = 255;
								var ctx = cvs.getContext("2d");
								node.onaudioprocess = function(){
									var a = new Uint8Array(analyser.frequencyBinCount);
									analyser.getByteFrequencyData(a);
									ctx.clearRect(0, 0, cvs.width, cvs.height);
									for(var i=0;i<a.length;++i){
										var f=i*44100/analyser.fftSize;
										var v=Ra*a[i];
										var Ra=12200*12200*f*f*f*f/(f*f+20.6*20.6)/(f*f+12200*12200)/Math.sqrt((f*f+107.7*107.7)*(f*f+737.9*737.9));
										ctx.fillStyle="rgba("+Math.round(255-i*255/a.length)+",255,"+Math.round(i*255/a.length)+","+v/255+")";
										var part=v*cvs.height/255;
										ctx.fillRect(i*cvs.width/a.length,cvs.height-part,1*cvs.width/a.length,part);
									}
								};
							}
						};
						connection.onCustomMessage = function(message) {
							return api[message[0]].apply(this, message.slice(1));
						}

						if (isMaster) {
							connection.session = {
								audio: true,
								video: data.video,
								data: true,
							};
							connection.open();
						} else {
							console.log('client connecting');
							var sessions = { };
							connection.connect();
						}
					});
				});
				socket.on('stop song', function(data){ // show data?
					$("#target").empty();
					if (connection) {
						connection.leave();
						connection = null;
					}
				});
			}
			if(location.hash) {
				var room = location.hash.substring(1);
				socket.emit('join room', room);
				join(room);
			} else {
				socket.emit('new room');
				socket.on('new room', function (room) {
					location.replace('#' + room);
					join(room);
				});
			}
			$(function(){
				var heartbeat = null;
				[
					function(){ // move decl of heartbeat to nearest enclosing function
						heartbeat = setInterval(function(){ // move to the video loop
							connection.sendCustomMessage(['heartbeat', Date.now()]);
						}, 1000);
					},
					function(){
						if (heartbeat !== null) {
							clearInterval(heartbeat);
							heartbeat = null;
						}
					},
				].map(function(f){
					$("#main")
						.append($("<button>").text(f.toString()).click(f))
						.append("<br>");
				});
			});
			
		// })();
  window.fbAsyncInit = function() {
  FB.init({
    appId      : '201019110094783',
    status     : true, // check login status
    cookie     : true, // enable cookies to allow the server to access the session
    xfbml      : true  // parse XFBML
  });

  // Here we subscribe to the auth.authResponseChange JavaScript event. This event is fired
  // for any authentication related change, such as login, logout or session refresh. This means that
  // whenever someone who was previously logged out tries to log in again, the correct case below 
  // will be handled. 
  FB.Event.subscribe('auth.authResponseChange', function(response) {
    // Here we specify what we do with the response anytime this event occurs. 
    if (response.status === 'connected') {
      console.log("1");
      // The response object is returned with a status field that lets the app know the current
      // login status of the person. In this case, we're handling the situation where they 
      // have logged in to the app.
      testAPI();
    } else if (response.status === 'not_authorized') {
      console.log("2");
      // In this case, the person is logged into Facebook, but not into the app, so we call
      // FB.login() to prompt them to do so. 
      // In real-life usage, you wouldn't want to immediately prompt someone to login 
      // like this, for two reasons:
      // (1) JavaScript created popup windows are blocked by most browsers unless they 
      // result from direct interaction from people using the app (such as a mouse click)
      // (2) it is a bad experience to be continually prompted to login upon page load.
    } else {
      console.log("3");
      // In this case, the person is not logged into Facebook, so we call the login() 
      // function to prompt them to do so. Note that at this stage there is no indication
      // of whether they are logged into the app. If they aren't then they'll see the Login
      // dialog right after they log in to Facebook. 
      // The same caveats as above apply to the FB.login() call here

      // FB.login(function(){
      //   console.log("posting to wall");
      //   FB.api('/me/feed', 'post', {message: 'Hello, world!'});
      // }, {scope: 'publish_actions'});
      console.log("4");
    }
  });
  };

  // Load the SDK asynchronously
  (function(d){
   var js, id = 'facebook-jssdk', ref = d.getElementsByTagName('script')[0];
   if (d.getElementById(id)) {return;}
   js = d.createElement('script'); js.id = id; js.async = true;
   js.src = "//connect.facebook.net/en_US/all.js";
   ref.parentNode.insertBefore(js, ref);
  }(document));

  // Here we run a very simple test of the Graph API after login is successful. 
  // This testAPI() function is only called in those cases. 
  function testAPI() {
    console.log('Welcome!  Fetching your information.... ');
    FB.api('/me', function(response) {
      console.log('Good to see you, ' + response.name + '.');
    });
    // FB.api('/me/feed', 'post', {message: 'Hello, world!'}, function(response) {
    //   callback(response);
    // });
  }

  function viewFriends(){
    /* make the API call */
    FB.api(
        "/me/friends",
        function (response) {
          if (response && !response.error) {
            console.log(response);
          }
        }
    );
  }
  function renderMFS() {
  // First get the list of friends for this user with the Graph API
  FB.api('/me/friends', function(response) {
   console.log(response); 
   var container = document.getElementById('mfs');
   console.log(container);
   var mfsForm = document.createElement('form');
   mfsForm.id = 'mfsForm';

   // Iterate through the array of friends object and create a checkbox for each one.
   for(var i = 0; i < Math.min(response.data.length, 1000); i++) {
     var friendItem = document.createElement('div');
     friendItem.id = 'friend_' + response.data[i].id;
     friendItem.innerHTML = '<input type="checkbox" name="friends" value="'
       + response.data[i].id
       + '" />' + response.data[i].name;
       mfsForm.appendChild(friendItem);
     }
     container.appendChild(mfsForm);

     // Create a button to send the Request(s)
     var sendButton = document.createElement('input');
     sendButton.type = 'button';
     sendButton.value = 'Send Request';
     sendButton.onclick = sendRequest;
     mfsForm.appendChild(sendButton);
   });
  }

  function sendRequest() {
  console.log("window location: " + window.location);
  // Get the list of selected friends
  var sendUIDs = '';
  var mfsForm = document.getElementById('mfsForm');
   for(var i = 0; i < mfsForm.friends.length; i++) {
     if(mfsForm.friends[i].checked) {
       sendUIDs += mfsForm.friends[i].value + ',';
     }
   }

  // Use FB.ui to send the Request(s)
  FB.ui({method: 'apprequests',
   to: sendUIDs,
   title: 'My Great Invite',

   message: 'copy&paste this URL: ' + window.location,
   redirect_uri: window.location,
    }, callback);
  }

  function callback(response) {
    if (!response || response.error) {
      alert('Error occured');
      console.log(response);
    }else {
          alert('Action was successful! Action ID: ' + response.id)
          console.log(response);
      }
  }

  $(document).ready(function(){
    $("#logout-button").bind('click', function(){
      FB.logout(function(response) {
        // Person is now logged out
      });
    });
    $("#inviteFriends").bind('click', function(){
      renderMFS();
    });

    $("#startSong").bind('click', function(){
      socket.emit('start song', {streamId: 'sid-' + rand(), src: userId, video: true});
    });
    $("#startSongBlind").bind('click', function(){
      socket.emit('start song', {streamId: 'sid-' + rand(), src: userId, video: false});
    });
    $("#upVote").bind('click', function(){
      socket.emit('vote', {good: true, src: userId});
    });
    $("#downVote").bind('click', function(){
      socket.emit('vote', {good: false, src: userId});
    });
  });

	</script>
</head>
<body>
	<div id="fb-root"></div>
	<style>
		html,body{
			height:100%;
			background-color:grey;
			color:white;
			font-size:1.2em;
			overflow:hidden;
		}
		.sidebar-container{
			width:23em;
			height:100%;
			float:right;
			padding:2em;
		}
		.main-container{
			height:100%;
			width:100%;
			padding:2em;
			padding-right:23em;
			padding-bottom:11em;
		}
		.sidebar{
			width:100%;
			height:100%;
			background-color:purple;
			border-radius:2em;
			padding:1em;
		}
		.main{
			width:100%;
			height:100%;
			background-color:#505;
			border-radius:2em;
			padding:1em;
			position:relative;
		}
		#target{
			width:100%;
			height:11em;
			padding:2em 0;
		}
		.player-container{
			position:absolute;
			border:0!important;
			padding:0!important;
			margin:0!important;
			background-color:transparent!important;
			left:-1em;
			top:-1em;
		}
		.self-master .main .video-container,.self-slave .main .video-container.player-container,{
			width:40%;
		}
		.self-master .main .video-container.player-container,.self-slave .main .video-container{
			width:100%;
		}
		.player{
			width:13em;
			height:11em;
			background-color:red;
			position:absolute;
			right:0;
			bottom:0;
		}
		.video-container{
			width:30%;
			margin:0 1em;
			height:100%;
			margin:0 auto;
			background-color:#505;
			border-radius:2em;
			padding:1em;
			display:inline-block;
		}
		.video-container video{
			display:block;
			margin:0 auto;
		}
		video.slave{
			height:100%;
		}
		canvas.spectrum{
			z-index:1;
			position:absolute;
			left:0;
			bottom:0;
			border-bottom:1px solid black;
		}
	</style>
	<div class="sidebar-container">
		<div class="sidebar">
			1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182
		</div>
	</div>
	<div class="main-container">
		<div class="main">
			<p>Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry's standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book. It has survived not only five centuries, but also the leap into electronic typesetting, remaining essentially unchanged.</p>
			<button href="#" type="button" class="btn btn-default" id="startSong">Start Song</button>
			<!--<button href="#" type="button" class="btn btn-default" id="startSongBlind">Start Song Blind</button>-->
			<button href="#" type="button" class="btn btn-default" id="upvote">Upvote</button>
			<button href="#" type="button" class="btn btn-default" id="downvote">Downvote</button>
			<button type="button" class="btn btn-default" id="logout-button">LOGOUT</button>
			<button type="button" class="btn btn-default" id="inviteFriends" scope="publish_actions">Invite Friends</button>
			<br>
			<fb:login-button show-faces="true" width="200" max-rows="1" scope="publish_actions"></fb:login-button>
			<p class="list-group-item-text" id="mfs"></p>
		</div>
		<div id="target">
		</div>
	</div>
</body>
</html>
