<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title></title>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
	<script src="http://www.rtcmulticonnection.org/latest.js"></script>
	<script src="/io.js"></script>
	<script src="/socket.io/socket.io.js"></script>
	<script>
		(function(){
			function rand(){
				return Math.random()*Math.pow(2,53);
			};
			// Init socketio
			var socket = io.connect("http://localhost:8000");
			var userId = 'user-' + rand();
			function join(room){
				var connection = null;
				socket.on('start song', function(data){ // client
					$(function(){
						var id = room + '-' + data.streamId
						var isMaster = userId == data.src;
						console.log('start song', id, data, 'src', isMaster);
						connection = new RTCMultiConnection(id);
						connection.disableDtlsSrtp = true;
						connection.autoCloseEntireSession = true;

						connection.onstream = function(e) {
							console.log('stream added', e);
							$("#target").append(e.mediaElement);
						};

						if (isMaster) {
							connection.session = {
								audio: true,
								video: true,
								oneway: true,
							};
							connection.open();
						} else {
							console.log('client connecting');
							var sessions = { };
							connection.onNewSession = function(session) {
								// if room is not transmitted once;
								// "onNewSession" will be called multiple times for same session;
								// we need to store session-id in an object.
								if (sessions[session.sessionid]) return;
								sessions[session.sessionid] = session;
							
								// you can call "captureUserMedia" to attach a custom stream even if session is oneway!
								connection.captureUserMedia(function() {
									// it is mandatory; otherwise; RTCMultiConnection will remove video stream
									connection.dontAttachStream = true;
							
									// "join" method must be invoked in the stream-callback
									connection.join(session);
								}, { video: true });
							};
							connection.connect();
						}
					});
				});
				socket.on('stop song', function(data){ // show data?
					$("#target").empty();
					if (connection) {
						connection.leave();
						connection = null;
					}
				});
			}
			if(location.hash) {
				var room = location.hash.substring(1);
				socket.emit('join room', room);
				join(room);
			} else {
				socket.emit('new room');
				socket.on('new room', function (room) {
					location.replace('#' + room);
					join(room);
				});
			}
			$(function(){
				[
					function(){
						socket.emit('start song', {streamId: 'sid-' + rand(), src: userId});
					},
					function(){
						socket.emit('vote', {good: true, src: userId});
					},
					function(){
						socket.emit('vote', {good: false, src: userId});
					},
				].map(function(f){
					$("body")
						.append($("<button>").text(f.toString()).click(f))
						.append("<br>");
				});
			});
			// Init facebook API
			window.fbAsyncInit = function() {
				FB.init({
					appId : '725325364157893',
					status: true,
					xfbml : true
				});
			};

			(function(d, s, id){
				 var js, fjs = d.getElementsByTagName(s)[0];
				 if (d.getElementById(id)) {return;}
				 js = d.createElement(s); js.id = id;
				 js.src = "//connect.facebook.net/en_US/all.js";
				 fjs.parentNode.insertBefore(js, fjs);
			 }(document, 'script', 'facebook-jssdk'));
		})();

	</script>
</head>
<body>
	<div id="fb-root"></div>
	<div id="target"></div>
</body>
</html>
